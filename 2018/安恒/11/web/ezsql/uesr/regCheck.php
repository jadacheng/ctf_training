<?php
include_once('../config/sys_config.php');
if (isset($_POST['submit'])){
	if(empty($_POST['username'])){
		$_SESSION['name_error'] = "????????????????????????????????????"; 
		header('Location: reg.php');
	}elseif(empty($_POST['New_pass'])){
		$_SESSION['input_error'] = "?????????????????????????????????"; 
		header('Location: reg.php');
	}elseif(empty($_POST['Re_pass'])){
		$_SESSION['input_error'] = "???????????????????????????????????????"; 
		header('Location: reg.php');
	}elseif(!empty($_POST['New_pass']) && !empty($_POST['Re_pass']) && $_POST['New_pass'] != $_POST['Re_pass']){
		$_SESSION['input_error'] = "?????????????????????????????????????????€???"; 
		header('Location: reg.php');
	}else{
		$clean_name = waf($_POST['username']);
		$clean_pass = waf($_POST['New_pass']);	
	$sql = "SELECT * FROM dwvs_user_message WHERE DWVS_user_name = '$clean_name'";
    $data = mysqli_query($connect, $sql);
   
	if (mysqli_num_rows($data) == 1) {
		$_SESSION['name_error'] = '?????????????????????????????????';
		mysqli_close($connect);
		header('Location: reg.php');
	}
	else{
		$_SESSION['user_name'] = $clean_name;
		$rand_num = rand(1,4);
		$user_favicon = "../favicon/"."$rand_num".".jpg";
		$_SESSION['user_favicon'] = $user_favicon;
		$password = md5($clean_pass);
		$time = date("Y-m-d");
		$sql2 = "INSERT INTO dwvs_user_message(DWVS_user_name,DWVS_user_passwd,DWVS_user_enr_time) VALUES ('$clean_name','$password','$time')";
		mysqli_query($connect,$sql2) or die("Error!!");
		mysqli_close($connect);
		header('Location: user.php');
		}
	}	
}else{
	not_find($_SERVER['PHP_SELF']);
}
?>